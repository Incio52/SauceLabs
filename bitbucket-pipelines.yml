# Serenity BDD Automation Pipeline
# This pipeline runs UI automation tests with Chrome browser

image: maven:3.8.6-openjdk-11

definitions:
  caches:
    maven: ~/.m2

pipelines:
  default:
    - step:
        name: Build and Test
        caches:
          - maven
        script:
          # Update system packages
          - apt-get update
          - apt-get install -y wget gnupg unzip curl
          
          # Install Google Chrome (updated method)
          - wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/googlechrome-linux-keyring.gpg
          - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/googlechrome-linux-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
          - apt-get update
          - apt-get install -y google-chrome-stable
          
          # Set environment variables
          - export DISPLAY=:99
          
          # Verify Chrome installation
          - google-chrome --version
          
          # Run Maven tests with CI configuration (WebDriver Manager will auto-download ChromeDriver)
          - mvn -B clean test "-Dserenity.configuration=serenity-ci.properties"
          
          # Generate Serenity reports
          - mvn serenity:aggregate
        artifacts:
          - target/serenity/**
          - target/screenshots/**
        after-script:
          # Collect checkstyle results if any
          - pipe: atlassian/checkstyle-report:0.3.0
          
    - step:
        name: Security Scan
        script:
          # Run security scan for sensitive data
          - pipe: atlassian/git-secrets-scan:0.5.1
